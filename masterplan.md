# AI Memory Agent - Master Plan

## 1. 프로젝트 비전

멀티채팅 환경에서 **권한 기반 메모리 관리**와 **RAG 문서 활용**을 통해
팀의 지식을 체계적으로 축적하고 AI가 이를 활용하여 맥락 있는 응답을 제공하는 시스템.

---

## 2. 현재 구현 완료 (v0.1.0)

### 2.1 핵심 기능

| 기능 | 상태 | 설명 |
|------|------|------|
| 사용자 인증 | ✅ | 로그인/회원가입, Base64+HMAC 토큰 |
| 멀티 대화방 | ✅ | 개인/프로젝트/부서 타입, 멤버 관리 |
| 실시간 메시지 | ✅ | WebSocket 기반, 자동 재연결 |
| AI 응답 | ✅ | @ai 멘션, 슬래시 커맨드 |
| 메모리 관리 | ✅ | 4단계 스코프 (개인/대화방/프로젝트/부서) |
| 자동 메모리 추출 | ✅ | 대화에서 LLM으로 중요 정보 자동 추출 |
| 시맨틱 검색 | ✅ | Qdrant 벡터 검색 |
| RAG 문서 업로드 | ✅ | PDF/TXT 업로드, 청킹, 임베딩 |
| 문서-대화방 연결 | ✅ | 다대다 연결, 대화방 설정에서 관리 |
| 컨텍스트 우선순위 | ✅ | 대화 > RAG 문서 > 메모리 |
| 컨텍스트 소스 설정 | ✅ | 대화방별 메모리/문서 소스 커스터마이징 |
| 관리자 페이지 | ✅ | 대시보드, 사용자/대화방/메모리/부서/프로젝트 관리 |
| 프론트엔드 | ✅ | React SPA, Notion 스타일 UI |

### 2.2 백엔드 모듈

```
src/
├── admin/          # 관리자 (대시보드, CRUD, 페이지네이션)
├── auth/           # 인증 (로그인, 회원가입, 토큰 검증)
├── chat/           # 채팅 (방 CRUD, 메시지, AI 응답, 슬래시 커맨드)
├── document/       # 문서 (업로드, 청킹, 임베딩, 연결)
├── mchat/          # Mattermost 연동 (구조만)
├── memory/         # 메모리 (CRUD, 시맨틱 검색)
├── permission/     # 권한 체크
├── user/           # 사용자/부서/프로젝트 관리
├── websocket/      # 실시간 채팅
└── shared/         # DB, 벡터스토어, LLM/Embedding 프로바이더
```

### 2.3 프론트엔드 모듈

```
frontend/src/features/
├── admin/          # 관리자 페이지 (대시보드, 탭별 관리)
├── auth/           # 로그인 폼, 인증 스토어
├── chat/           # 대화방 UI, 메시지, 멤버, 컨텍스트 설정
├── document/       # 문서 업로드, 목록, 관리
├── memory/         # 메모리 검색, 목록
└── project/        # 프로젝트 관리
```

### 2.4 DB 스키마

```
users ──┬── departments
        ├── projects ── project_members
        ├── chat_rooms ── chat_room_members
        │                 chat_messages
        ├── memories (personal/chatroom/project/department)
        └── documents ── document_chunks
                         document_chat_rooms (다대다)
```

### 2.5 AI 파이프라인

```
사용자 메시지 (@ai 멘션)
    │
    ├─ 1. 최근 대화 20개 조회 (최우선 컨텍스트)
    │
    ├─ 2. RAG 문서 검색 (대화방 연결 문서 → Qdrant 벡터 검색)
    │      └─ scope="document" + document_id 필터
    │
    ├─ 3. 메모리 검색 (컨텍스트 소스 설정 기반)
    │      ├─ 이 대화방 메모리
    │      ├─ 다른 대화방 메모리 (설정 시)
    │      ├─ 개인 메모리 (설정 시)
    │      ├─ 프로젝트 메모리 (설정 시)
    │      └─ 부서 메모리 (설정 시)
    │
    ├─ 4. 시스템 프롬프트 조립
    │      ├─ [참고 문서] (RAG, 높은 우선순위)
    │      └─ [저장된 메모리] (보조)
    │
    ├─ 5. LLM 응답 생성
    │
    └─ 6. 대화에서 자동 메모리 추출 + 저장
```

---

## 3. 향후 계획

### Phase 1: Samsung Mchat 연동

Samsung 사내 메신저(Mattermost 기반)와 연동하여 기존 채팅 환경에서 AI Memory Agent를 활용.

**구현 방식**: Outgoing Webhook + Incoming Webhook 조합
- Mchat에서 `@ai`, `/remember` 등 트리거 → AI Agent 호출
- AI Agent 응답 → Incoming Webhook으로 Mchat에 전송
- 채널/사용자 매핑 테이블 구축

**참고**: `mchat_plan.md`에 상세 연동 계획 문서화됨

### Phase 2: 고급 RAG 기능

| 기능 | 설명 |
|------|------|
| 추가 파일 형식 | DOCX, XLSX, PPT, Markdown 지원 |
| 청킹 전략 개선 | 시맨틱 청킹, 재귀적 청킹 |
| 하이브리드 검색 | 벡터 + 키워드 검색 조합 |
| 문서 버전 관리 | 동일 문서 재업로드 시 버전 추적 |
| 문서 요약 | 업로드 시 자동 요약 생성 |

### Phase 3: 메모리 고도화

| 기능 | 설명 |
|------|------|
| 메모리 충돌 감지 | 상반되는 정보 저장 시 알림 |
| 메모리 만료 | TTL 기반 자동 정리 |
| 메모리 그래프 | 관련 메모리 간 연결 시각화 |
| 중복 메모리 병합 | 유사 메모리 자동 병합 |
| 메모리 공유 | 특정 메모리를 다른 대화방에 공유 |

### Phase 4: 운영 안정성

| 기능 | 설명 |
|------|------|
| 로깅/모니터링 | 구조화된 로깅, 메트릭 수집 |
| 에러 핸들링 강화 | 재시도, 서킷 브레이커 |
| 성능 최적화 | DB 쿼리 최적화, 캐싱 |
| 테스트 커버리지 | 단위/통합 테스트 확충 |
| Docker 배포 | Dockerfile, docker-compose |
| CI/CD | GitHub Actions 파이프라인 |

### Phase 5: 확장 기능

| 기능 | 설명 |
|------|------|
| 멀티 LLM 라우팅 | 질문 유형별 최적 모델 선택 |
| 스트리밍 응답 | SSE 기반 점진적 응답 |
| 음성 인터페이스 | STT/TTS 연동 |
| 모바일 앱 | React Native 또는 PWA |
| 플러그인 시스템 | 외부 도구 연동 (캘린더, JIRA 등) |

---

## 4. 아키텍처 다이어그램

```
┌──────────────────────────────────────────────────────────────┐
│                        클라이언트                              │
│  ┌─────────────┐  ┌───────────────┐  ┌─────────────────┐    │
│  │  React SPA  │  │  Samsung Mchat │  │  Streamlit (옛) │    │
│  │  (포트 3000) │  │  (Webhook)     │  │                 │    │
│  └──────┬──────┘  └───────┬───────┘  └────────┬────────┘    │
└─────────┼─────────────────┼───────────────────┼──────────────┘
          │ REST/WS         │ HTTP              │ REST
          ▼                 ▼                   ▼
┌──────────────────────────────────────────────────────────────┐
│                   FastAPI 백엔드 (포트 8000)                    │
│                                                                │
│  ┌────────┐ ┌────────┐ ┌──────────┐ ┌──────────┐            │
│  │  Auth  │ │  Chat  │ │ Document │ │  Admin   │            │
│  └────────┘ └───┬────┘ └────┬─────┘ └──────────┘            │
│                 │            │                                 │
│           ┌─────▼────────────▼─────┐                          │
│           │   AI Response Engine    │                          │
│           │  (우선순위 컨텍스트)      │                          │
│           └─────┬──────────┬───────┘                          │
│                 │          │                                   │
│           ┌─────▼───┐ ┌───▼──────┐                            │
│           │ Memory  │ │ Document │                            │
│           │ Service │ │ Service  │                            │
│           └────┬────┘ └────┬─────┘                            │
└────────────────┼───────────┼──────────────────────────────────┘
                 │           │
        ┌────────▼───┐  ┌───▼────────┐
        │   SQLite   │  │   Qdrant   │
        │ (메인 DB)   │  │ (벡터 DB)  │
        └────────────┘  └────────────┘

        ┌────────────────────────────┐
        │   LLM / Embedding API      │
        │  (OpenAI호환, HuggingFace)  │
        └────────────────────────────┘
```

---

## 5. 데이터 흐름

### 메모리 저장 흐름
```
사용자: /remember 김과장은 오전 회의 선호
  → 텍스트 임베딩 생성
  → 개인 메모리 저장 (SQLite + Qdrant)
  → 대화방 메모리 저장 (SQLite + Qdrant)
  → (옵션) 부서/프로젝트 메모리 저장
```

### 문서 업로드 흐름
```
사용자: PDF 파일 업로드
  → 텍스트 추출 (PyPDF2)
  → 청킹 (800자, 100자 오버랩)
  → 각 청크 임베딩 → Qdrant 저장 (scope=document)
  → 문서 메타데이터 SQLite 저장
  → (선택) 대화방에 연결
```

### AI 응답 흐름
```
사용자: @ai 오늘 회의 몇 시야?
  → 최근 대화 20개 조회
  → 연결 문서 벡터 검색 (Qdrant, scope=document)
  → 메모리 벡터 검색 (Qdrant, 컨텍스트 소스 기반)
  → 시스템 프롬프트 조립 (문서 > 메모리 우선순위)
  → LLM 응답 생성
  → 대화에서 자동 메모리 추출
  → 응답 반환 + WebSocket 브로드캐스트
```

---

## 6. 기술 결정 기록

| 결정 | 선택 | 이유 |
|------|------|------|
| 메인 DB | SQLite | 설치 불필요, 단일 파일, 개발 편의성 |
| 벡터 DB | Qdrant | 오픈소스, 필터링 지원, payload 저장 |
| 백엔드 | FastAPI | 비동기, 자동 문서화, 타입 안전 |
| 프론트엔드 | React + Vite | 생태계, 빌드 속도 |
| 상태관리 | Zustand + TanStack Query | 간결함, 서버 상태 분리 |
| 인증 | Base64+HMAC | 외부 의존성 없이 간단한 토큰 인증 |
| 청킹 | 800자 + 100자 오버랩 | 일반적인 RAG 권장 사이즈 |
| 컨텍스트 우선순위 | 대화 > 문서 > 메모리 | 현재 맥락 최우선, 문서는 사실 기반, 메모리는 보조 |

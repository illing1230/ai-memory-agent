# Mchat ì—°ë™ ê²€í†  ì‚¬í•­

## 1. í˜„ì¬ ìƒíƒœ

### ì—°ê²° ì„±ê³µ âœ…
- **URL**: `https://mchat.mosaic.sec.samsung.net`
- **ì¸ì¦**: Bearer Token ë°©ì‹
- **WebSocket**: ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹  ë™ì‘ í™•ì¸

### ìˆ˜ì‹ ë˜ëŠ” ì´ë²¤íŠ¸
| ì´ë²¤íŠ¸ | ì„¤ëª… | ìƒíƒœ |
|--------|------|------|
| `hello` | WebSocket ì—°ê²° ì„±ê³µ | âœ… |
| `channel_viewed` | ì±„ë„ ì¡°íšŒ | âœ… |
| `posted` | ìƒˆ ë©”ì‹œì§€ | âœ… |
| `typing` | íƒ€ì´í•‘ ì¤‘ | âœ… |

---

## 2. ì•„í‚¤í…ì²˜ ê²°ì • ì‚¬í•­

### 2.1 ì—°ë™ ë°©ì‹: WebSocket vs Webhook

| í•­ëª© | WebSocket (í˜„ì¬) | Outgoing Webhook |
|------|-----------------|------------------|
| ì—°ê²° ë°©ì‹ | ìƒì‹œ ì—°ê²° ìœ ì§€ | ìš”ì²­ ì‹œì—ë§Œ |
| ì„œë²„ ë¶€ë‹´ | ë†’ìŒ | ë‚®ìŒ |
| Private ì±„ë„ | âœ… ê°€ëŠ¥ | âŒ Publicë§Œ |
| DM | âœ… ê°€ëŠ¥ | âŒ ë¶ˆê°€ |
| ìŠ¤ì¼€ì¼ ì•„ì›ƒ | ì–´ë ¤ì›€ | ì‰¬ì›€ |
| ì„¤ì • | ì½”ë“œë§Œ | Mchat ê´€ë¦¬ì í•„ìš” |

**í˜„ì¬ ê²°ì •**: WebSocket ë°©ì‹ ì‚¬ìš© (Private ì±„ë„, DM ì§€ì› í•„ìš”)

### 2.2 ë©”ì‹œì§€ ì²˜ë¦¬ ë²”ìœ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë©”ì‹œì§€ ì²˜ë¦¬ ì •ì±…                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  [ìˆ˜ì‹  ëŒ€ìƒ]                                                     â”‚
â”‚  âœ… ë‚´ ë©”ì‹œì§€ - ë©”ëª¨ë¦¬ ì €ì¥ (AI ì‘ë‹µì€ ì•ˆ í•¨)                    â”‚
â”‚  âœ… ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ - ë©”ëª¨ë¦¬ ì €ì¥ + AI ì‘ë‹µ                     â”‚
â”‚  âœ… @ai ë©˜ì…˜ - AI ì‘ë‹µ íŠ¸ë¦¬ê±°                                    â”‚
â”‚  âœ… /remember - ëª…ì‹œì  ë©”ëª¨ë¦¬ ì €ì¥                               â”‚
â”‚  âœ… /search - ë©”ëª¨ë¦¬ ê²€ìƒ‰                                        â”‚
â”‚                                                                  â”‚
â”‚  [ì €ì¥ ëŒ€ìƒ]                                                     â”‚
â”‚  âœ… ëª¨ë“  ë©”ì‹œì§€ â†’ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥                             â”‚
â”‚  âœ… ì¤‘ìš” ì •ë³´ â†’ ë©”ëª¨ë¦¬ ìë™ ì¶”ì¶œ                                 â”‚
â”‚  âŒ AI ì‘ë‹µ â†’ ì €ì¥í•˜ì§€ ì•ŠìŒ (ë˜ëŠ” ë³„ë„ í‘œì‹œ)                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. êµ¬í˜„ í•„ìš” ì‚¬í•­

### 3.1 ë©”ì‹œì§€ ì²˜ë¦¬ ë¡œì§

```python
# ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì²˜ë¦¬ íë¦„
async def handle_posted(event):
    post = event["data"]["post"]
    user_id = post["user_id"]
    message = post["message"]
    channel_id = post["channel_id"]
    
    # 1. ë©”ì‹œì§€ ì €ì¥ (ë‚´ ë©”ì‹œì§€ í¬í•¨)
    await save_message_to_history(channel_id, user_id, message)
    
    # 2. ë©”ëª¨ë¦¬ ìë™ ì¶”ì¶œ (ì¤‘ìš” ì •ë³´)
    memories = await extract_memories(message)
    if memories:
        await save_memories(memories, channel_id, user_id)
    
    # 3. AI ì‘ë‹µ (ë‚´ ë©”ì‹œì§€ëŠ” ì œì™¸)
    if user_id != BOT_USER_ID:
        if "@ai" in message or message.startswith("/"):
            response = await generate_ai_response(message, channel_id)
            await send_response(channel_id, response)
```

### 3.2 ì±„ë„-ì±„íŒ…ë°© ë§¤í•‘

```sql
-- Mchat ì±„ë„ â†” AI Memory Agent ì±„íŒ…ë°© ë§¤í•‘
CREATE TABLE mchat_channel_mapping (
    id TEXT PRIMARY KEY,
    mchat_channel_id TEXT UNIQUE NOT NULL,
    mchat_channel_name TEXT,
    mchat_team_id TEXT,
    agent_room_id TEXT REFERENCES chat_rooms(id),
    sync_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 ì‚¬ìš©ì ë§¤í•‘

```sql
-- Mchat ì‚¬ìš©ì â†” AI Memory Agent ì‚¬ìš©ì ë§¤í•‘
CREATE TABLE mchat_user_mapping (
    id TEXT PRIMARY KEY,
    mchat_user_id TEXT UNIQUE NOT NULL,
    mchat_username TEXT,
    agent_user_id TEXT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 4. ê²€í†  í•„ìš” ì‚¬í•­

### 4.1 Mchat ê´€ë¦¬ì í™•ì¸ í•„ìš”

| í•­ëª© | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| Bot Account ìƒì„± | â³ ìš”ì²­ í•„ìš” | í˜„ì¬ ê°œì¸ í† í° ì‚¬ìš© ì¤‘ |
| Bot Token ë°œê¸‰ | â³ ìš”ì²­ í•„ìš” | |
| API Rate Limit | â“ í™•ì¸ í•„ìš” | ê¸°ë³¸ê°’ 10req/sec |
| ì±„ë„ ì ‘ê·¼ ê¶Œí•œ | â“ í™•ì¸ í•„ìš” | Bot ì´ˆëŒ€ ë°©ì‹ |

### 4.2 Bot Account ìš”ì²­ ì‚¬í•­

```
Bot Account ìƒì„± ìš”ì²­:
- Username: ai-memory-bot
- Display Name: AI Memory Bot
- ì•„ì´ì½˜: ğŸ¤– ë˜ëŠ” ì»¤ìŠ¤í…€ ì´ë¯¸ì§€
- ê¶Œí•œ:
  - ë©”ì‹œì§€ ì½ê¸°/ì“°ê¸°
  - ì±„ë„ ì°¸ì—¬
  - ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
```

### 4.3 ë³´ì•ˆ ê²€í† 

- [ ] í† í° ì €ì¥ ë°©ì‹ (í™˜ê²½ë³€ìˆ˜, Vault ë“±)
- [ ] ë¯¼ê°ì •ë³´ í•„í„°ë§ (ê°œì¸ì •ë³´, ë¹„ë°€ë²ˆí˜¸ ë“±)
- [ ] ë¡œê·¸ì— í† í°/ë¯¼ê°ì •ë³´ ë…¸ì¶œ ë°©ì§€
- [ ] ë©”ì‹œì§€ ì•”í˜¸í™” ì „ì†¡ í™•ì¸ (HTTPS)

---

## 5. Streamlit + Mchat í†µí•© êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      í†µí•© ì•„í‚¤í…ì²˜                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [Streamlit UI :8501]                                           â”‚
â”‚   â€¢ ë©”ëª¨ë¦¬ ê´€ë¦¬/ê²€ìƒ‰                                             â”‚
â”‚   â€¢ ëŒ€ì‹œë³´ë“œ                                                     â”‚
â”‚   â€¢ ì„¤ì •                                                         â”‚
â”‚        â”‚                                                         â”‚
â”‚        â–¼                                                         â”‚
â”‚   [FastAPI :8000]                                                â”‚
â”‚   â€¢ /api/v1/memories                                             â”‚
â”‚   â€¢ /api/v1/chat-rooms                                           â”‚
â”‚   â€¢ /api/v1/users                                                â”‚
â”‚        â”‚                                                         â”‚
â”‚        â–¼                                                         â”‚
â”‚   [SQLite + Qdrant] â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚   â€¢ messages í…Œì´ë¸”                       â”‚                       â”‚
â”‚   â€¢ memories í…Œì´ë¸”                       â”‚                       â”‚
â”‚   â€¢ ë²¡í„° ì¸ë±ìŠ¤                           â”‚                       â”‚
â”‚        â–²                                 â”‚                       â”‚
â”‚        â”‚                                 â”‚                       â”‚
â”‚   [Mchat WebSocket Worker]               â”‚                       â”‚
â”‚   â€¢ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚   â€¢ ë©”ëª¨ë¦¬ ìë™ ì¶”ì¶œ                                             â”‚
â”‚   â€¢ AI ì‘ë‹µ ì „ì†¡                                                 â”‚
â”‚        â”‚                                                         â”‚
â”‚        â–¼                                                         â”‚
â”‚   [Samsung Mchat]                                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì‹¤í–‰ ë°©ì‹

```bash
# ë°©ë²• 1: ë³„ë„ í”„ë¡œì„¸ìŠ¤
uvicorn src.main:app --port 8000 &
python -m src.mchat.worker &
streamlit run app/streamlit_app.py --server.port 8501

# ë°©ë²• 2: FastAPI ì‹œì‘ ì‹œ WebSocket ì›Œì»¤ í•¨ê»˜ ì‹¤í–‰
# (main.pyì—ì„œ ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ë¡œ)
```

---

## 6. ë‹¤ìŒ ë‹¨ê³„

### Phase 1: ê¸°ë³¸ ì—°ë™ (1ì£¼)
- [x] WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸
- [x] ë©”ì‹œì§€ ìˆ˜ì‹  í™•ì¸
- [ ] ë©”ì‹œì§€ ì €ì¥ ë¡œì§ êµ¬í˜„
- [ ] ì±„ë„/ì‚¬ìš©ì ë§¤í•‘ í…Œì´ë¸” ìƒì„±
- [ ] ê¸°ë³¸ ì»¤ë§¨ë“œ ì—°ë™ (@ai, /remember)

### Phase 2: ë©”ëª¨ë¦¬ ì—°ë™ (1ì£¼)
- [ ] Mchat ë©”ì‹œì§€ â†’ Memory ì €ì¥
- [ ] ë©”ëª¨ë¦¬ ê²€ìƒ‰ â†’ Mchat ì‘ë‹µ
- [ ] ìë™ ë©”ëª¨ë¦¬ ì¶”ì¶œ

### Phase 3: ì•ˆì •í™” (1ì£¼)
- [ ] Bot Account ì „í™˜
- [ ] ì—ëŸ¬ í•¸ë“¤ë§
- [ ] ì¬ì—°ê²° ë¡œì§ ê°•í™”
- [ ] ëª¨ë‹ˆí„°ë§/ë¡œê¹…

---

## 7. í™˜ê²½ë³€ìˆ˜

```env
# .env íŒŒì¼
MCHAT_URL=https://mchat.mosaic.sec.samsung.net
MCHAT_TOKEN=sig14w8mj7naxnmdzghk4qa88w
MCHAT_ENABLED=true

# Bot Account ì „í™˜ ì‹œ (ì¶”í›„)
# MCHAT_TOKEN=<bot-token>
# MCHAT_BOT_USER_ID=<bot-user-id>
```

---

## 8. ì°¸ê³  ìë£Œ

- [Mattermost API v4 Reference](https://api.mattermost.com/)
- [Mattermost WebSocket Events](https://developers.mattermost.com/integrate/reference/websocket-events/)
- [Mattermost Bot Accounts](https://developers.mattermost.com/integrate/reference/bot-accounts/)
